<head>
<script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-auth.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-firestore.js"></script>
    <script>
      var firebaseConfig = {
        apiKey: "AIzaSyDJUuuatsSo59hUnFNV7_sg8btKVDL-PVc",
        authDomain: "the-phantom-7454f.firebaseapp.com",
        projectId: "the-phantom-7454f",
        storageBucket: "the-phantom-7454f.appspot.com",
        messagingSenderId: "394749240812",
        appId: "1:394749240812:web:2419ac8b17042f4e6c0cc9",
        measurementId: "G-2Q9EGXPTBX"
      };
      firebase.initializeApp(firebaseConfig);
    </script>
</head>

<div id="main-content">
  <div class="content-wrapper">
    <div id="search-container">
      <div class="dropdown-container">
        <input type="text" id="search-input" placeholder="Search for a case by keyword, parties or citation" oninput="filterDropdown();" autocomplete="off" />
        <div id="case-titles" class="dropdown-items"></div>
      </div>
      <button type="button" onclick="searchCase()">Summarise</button>
    </div>
    <div id="loading"></div>
  </div>
  <div id="summary-container">
    <div id="summary"></div>
  </div>
  <p id="disclaimer">
    Contains public sector information licensed under the Open Government Licence v3.0. This summary was generated by AI and may contain inaccurate information. The summary is intended for informational purposes only.
  </p>
</div>

<script>
const caseNamesURL = 'https://ayushsanghavi13.github.io/case-snappy/caseNames.json';

fetch(caseNamesURL)
  .then(response => response.json())
  .then(data => {
    const cases = data.cases;
    populateDropdown(cases);
  })
  .catch(error => {
    console.error(error);
  });
  
const caseTitlesList = document.getElementById("case-titles");

function populateDropdown(cases) {
  cases.forEach(caseItem => {
    const item = document.createElement("div");
    item.innerText = caseItem.name;
    item.dataset.keywords = caseItem.keywords.join(' ').toLowerCase();
    item.onclick = function () {
      document.getElementById("search-input").value = this.innerText;
      closeDropdown();
    };
    caseTitlesList.appendChild(item);
  });
}

function filterDropdown() {
  const searchTerm = document.getElementById("search-input").value.toLowerCase();
  const items = caseTitlesList.getElementsByTagName("div");

  const relevanceScores = [];
  for (const item of items) {
    let score = 0;
    if (item.innerText.toLowerCase().includes(searchTerm) || item.dataset.keywords.includes(searchTerm)) {
      score = searchTerm.length;
    }
    relevanceScores.push({ item, score });
  }

  relevanceScores.sort((a, b) => b.score - a.score);

  for (let i = 0; i < relevanceScores.length; i++) {
    if (i < 20 && relevanceScores[i].score > 0) {
      relevanceScores[i].item.style.display = "";
    } else {
      relevanceScores[i].item.style.display = "none";
    }
  }

  if (searchTerm) {
    caseTitlesList.style.display = "block";
    document.body.style.paddingBottom = "2rem";
  } else {
    caseTitlesList.style.display = "none";
    document.body.style.paddingBottom = "0";
  }
}

function closeDropdown() {
  caseTitlesList.style.display = "none";
  document.body.style.paddingBottom = "0";
}

  function startsWithKeyword(line, keywords) {
  const regex = new RegExp(`^(${keywords.join('|')})(:|\\s?:)?`, 'i');
  return regex.test(line);
}

function wrapWithTag(tag, text) {
  return `<${tag}>${text}</${tag}>`;
}

function formatSummary(summary) {
  return summary;
}

function showWarningPopup(message) {
  const warningPopup = document.createElement("div");
  warningPopup.textContent = message;
  warningPopup.style.position = "absolute";
  warningPopup.style.top = "0px";
  warningPopup.style.left = "50%";
  warningPopup.style.transform = "translateX(-50%)";
  warningPopup.style.padding = "0.5rem";
  warningPopup.style.backgroundColor = "#000000";
  warningPopup.style.color = "#fff";
  warningPopup.style.fontSize = "1rem";
  warningPopup.style.textAlign = "center";
  warningPopup.style.borderRadius = "5px";
  warningPopup.style.fontFamily = "Inter, sans-serif";
  warningPopup.style.zIndex = "2";
  
  // Find the container where you want to add the warning popup
  const container = document.getElementById("main-content");
  container.insertBefore(warningPopup, container.firstChild);

  // Remove the warning popup after 1.5 seconds
  setTimeout(() => {
    container.removeChild(warningPopup);
  }, 1500);
}

async function searchCase() {
  const submitButton = document.querySelector("#search-container button[type='button']");
  submitButton.disabled = true;

  const disclaimer = document.getElementById("disclaimer");
  disclaimer.style.display = "none";

const caseTitle = document.getElementById("search-input").value.trim();
  if (!caseTitle) {
    showWarningPopup("Please enter a valid case.");
    submitButton.disabled = false;
    return;
  }

  const caseItems = Array.from(caseTitlesList.children);
  const selectedCase = caseItems.find(item => item.innerText.toLowerCase() === caseTitle.toLowerCase());
  if (!selectedCase) {
    showWarningPopup("Please choose a valid case from the dropdown.");
    submitButton.disabled = false;
    return;
  }

  const loadingIndicator = document.getElementById("loading");
  const summaryContainer = document.getElementById("summary");
  loadingIndicator.style.display = "block";
  summaryContainer.innerText = "";

  const today = new Date().toDateString();
  const summaryDate = localStorage.getItem("summaryDate");
  let summaryCount = localStorage.getItem("summaryCount") || 0;

  // Reset the count if the date has changed
  if (summaryDate !== today) {
    localStorage.setItem("summaryCount", "0");
    localStorage.setItem("summaryDate", today);
    summaryCount = 0;
  }

  if (summaryCount >= 25) {
    window.location.href = "https://casesnappy.com/app/limit-reached-student";
    return;
  }
  
  firebase.firestore().collection("secrets").doc("PI7qq1sgxmno98MGduk3").get().then((doc) => {
    const apiKey = doc.data().apiKey;
    const messages = [
      {
        "role": "system",
        "content": `You are an English Law professor. Write a concise summary of ${caseTitle} for law students in a total of 300 words or less. Structure the summary as facts, then issues, then decision, with separate headings for each section as follows: 'Facts', 'Issues', 'Decision' and 'Key passage(s)'. Each heading should be above its content. The 'Issues' section should include the argument levied by each party. Include only easily digestible, short paragraphs. If you refer to any other cases, ensure you explain why they are relevant. If you use any legal abbreviations, please also provide their full form in brackets. If possible, please also select between one and three short key passages from the judgement under the separate heading 'Key passage', and make clear which judge wrote them by putting their name in brackets directly after the passage.`
      }
    ];

    fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: messages,
        max_tokens: 450,
        n: 1,
        stop: null,
        temperature: 0.7,
      }),
      timeout: 60000,
    })
    .then(response => response.json())
    .then(data => {
      const summary = data.choices[0].message.content;
      const formattedSummary = formatSummary(summary);
     
      loadingIndicator.style.display = "none";
      summaryContainer.innerHTML = formattedSummary;
      disclaimer.style.display = "block";
      submitButton.disabled = false;

      localStorage.setItem("summaryCount", parseInt(summaryCount) + 1);
    })
    .catch(err => {
      console.error(err);
      showWarningPopup("Failed to generate summary. Please try again later.");
      submitButton.disabled = false;
    });
  });
}
</script>
